<html>
  <head>
    <title>d3-form :: example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="d3.v3.min.js"></script>
    <style>
      form .fields, form .field, form .submit {
        display: inline-block;
        margin: 2px;
      }

      form label {
        margin-right: 2px;
        margin-left: 4px;
      }
    </style>
  </head>
  <body>
    <script src="../build/build.js"></script>
    <script>
      var Form = require('d3-form');
      
      var data = [
        { name: "Aaron", age: 51, color: "red" },
        { name: "Bertha", age: 2, color: "purple" },
        { name: "Celyne", age: 22, color: "blue" }
      ]

      var curs = 0;

      function render(){
        d3.select('body').call( 
          Form().data( extend({},data[curs]) )
            .bindInput( logInput )
            .on( 'reset', function(){ render(); } )
            .on( 'submit.log', log('submitted') )
            .on( 'reset.log', log('reset') )
            .fieldset(
              inputText('name').label('Name'),
              inputText('age').label('Age'),
              inputText('color').label('Favorite Color')
            )
            .legend('Stats')
            .field( link('reset').dispatches('reset') )
            .field( link('random').onclick( function(){
                      d3.event.preventDefault();
                      curs = Math.floor( Math.random() * data.length );
                      render();
                    })
            )
            .submit('Save')
        )
      }

      render(data[0]);

      function extend(object) {
        // Takes an unlimited number of extenders.
        var args = Array.prototype.slice.call(arguments, 1);

        // For each extender, copy their properties on our object.
        for (var i = 0, source; source = args[i]; i++) {
          if (!source) continue;
          for (var property in source) {
            object[property] = source[property];
          }
        }
        return object;
      }

      function logInput(key,val){
        console.log('%s => %s', key, val);
      }

      function log(msg){
        return function(){
          console.log(msg);
        }
      }

      function link(name){

        var labeltext = name
          , dispatcher
          , evtname
          , onclick

        render.dispatch = function(_){
          dispatcher = _; return this;
        }

        render.label = function(_){
          labeltext = _; return this;
        }

        render.dispatches = function(_){
          evtname = _; return this;
        }

        render.onclick = function(_){
          onclick = _; return this;
        }

        render.enter = function(enter){
          enter.append('a').classed(name,true).attr('href','#');
        }

        function render(form){
          var a = form.select('a.'+name);
          a.text(labeltext);
          if (dispatcher){
            a.on('click', dispatch);
          }
          if (onclick){
            a.on('click', onclick);
          }
        }

        function dispatch(){
          if (undefined === evtname) return;
          d3.event.preventDefault();
          dispatcher[evtname]();
        }

        return render;
      }


      function inputText(name){

        var labeltext
          , labelSelector = "label[for="+name+"]"
          , nameSelector = "input[name="+name+"]"
          , dispatcher

        render.dispatch = function(_){
          dispatcher = _; return this;
        }

        render.label = function(_){
          labeltext = _; return this;
        }

        render.enter = function(enter){
          enter.append('label').attr('for',name);
          enter.append('input').attr('type','text').attr('name',name);
        }

        function render(form){
          if (!(undefined === labeltext)){
            var label = form.select( labelSelector );
            label.text(labeltext);
          }
          var field = form.select( nameSelector );
          field.attr('value', valueAccessor );
          field.property('value', field.property('defaultValue'));
          if (dispatcher){
            field.on('change', dispatchInput );
          }
        }

        function valueAccessor(d){
          return d[name];
        }
        
        function dispatchInput(){
          dispatcher.input(this.getAttribute('name'), this.value);
        }

        return render;
      }

    </script>
  </body>
</html>

